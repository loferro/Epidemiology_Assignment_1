---
title: "Assignment 1"
author: "Ferrara Lorenzo, Lucchini Marco"
output: html_notebook
---

## Description
#### The data were collected during a study of the settlement pattern of common terns on a small islet in the Delta d’Ebre (Hernandez and Ruiz, 2003), particularly in the mouths of the Ebre river. The islet was inspected at two-day intervals throughout the 2000 breeding season. The data include the location of each nest, its elevation above sea level, and elevations at a number of additional points (points without nest) on the islet. In the file called elevationsIslet.txt, contains the information of the coordinates and elevation above sea, and in file, called poly84.txt contains the coordinates of the borders of the islet. The aim is to predict the elevation above sea level along the small islet using a kriging interpolation. 

```{r}
poly84 <- read.delim("poly84.txt")
names(poly84)= c("x", "y", "data")
head(poly84)
elevationsIslet <- read.delim("elevationsIslet.txt")
head(elevationsIslet)

# dataset = rbind(poly84, elevationsIslet)
dataset = elevationsIslet
```

```{r}
plot(poly84[,1:2], type="l")
col = rainbow(length(elevationsIslet$x))
order = order(elevationsIslet$data)

points(elevationsIslet[,1:2], col=col[order])
```


```{r}
library(geoR)
library(gstat)
```

```{r}
geodataset <- as.geodata(dataset)
plot(geodataset)
```

```{r}
lm <- lm(data ~ x + y, data = dataset)
summary(lm)
```

```{r}
lm <- lm(data ~ y, data = dataset)
summary(lm)
```

```{r}
residuals <- round(residuals(lm), digits = 3)
dataset.new <- cbind(dataset, residuals)
head(dataset.new)
```

```{r}
geodataset.residuals <- as.geodata(dataset.new, data.col = 4)
plot(geodataset.residuals)
```

### Variogram Could
```{r}
vario.cloud.classical <- variog(geodata = geodataset.residuals, option = "cloud", estimator.type = "classical")
plot(vario.cloud.classical, main = "CLOUD", cex.main = 1, cex.lab = 1)
```

```{r}
dist.max.data <- max(dist(cbind(dataset.new$x, dataset.new$y)))
#maximum distances between points

vario.cloud.classical <- variog(geodata = geodataset.residuals,option = "cloud", estimator.type = "classical", max.dist = dist.max.data/2)

plot(vario.cloud.classical, main = "CLOUD", cex.main = 1, cex.lab = 1)
```

```{r}
dist.max.data <- max(dist(cbind(dataset.new$x, dataset.new$y)))

vario.bc.classical <- variog(geodata = geodataset.residuals, option = "bin",bin.cloud = TRUE, pairs.min = 30, max.dist = dist.max.data/2,estimator.type = "classical")

plot(vario.bc.classical, bin.cloud = TRUE, cex.lab = 1, main = "\nBINNED BOXPLOTS",cex.main = 1)
```

```{r}
round(vario.bc.classical$bins.lim, 2)
```

```{r}
vario.bc.classical$ind.bin
```

```{r}
vario.bc.classical$n
```

```{r}
vario.bc.classical <- variog(geodata = geodataset.residuals, option = "bin",bin.cloud = TRUE, pairs.min = 30, max.dist = dist.max.data/2,estimator.type = "classical", uvec = seq(1, dist.max.data/2,l = 13))

plot(vario.bc.classical, bin.cloud = TRUE, cex.lab = 1, main = "\nBINNED BOXPLOTS",cex.main = 1)
```

```{r}
round(vario.bc.classical$bins.lim, 2)
vario.bc.classical$ind.bin
```


Empirical Variogram
```{r}
vario.b.classical <- variog(geodata = geodataset.residuals, option = "bin",pairs.min = 30, max.dist = dist.max.data/2, estimator.type = "classical",uvec = seq(1, dist.max.data/2, l = 13))

plot(vario.b.classical, main = "EMPIRICAL VARIOGRAMS (Classical)\nBINNED",cex.main = 1, cex.lab = 1, cex = 1, pch = 16)
```

```{r}
par(mfrow = c(1, 3))# cloud variogram
vario.cloud.robust <- variog(geodata = geodataset.residuals, option = "cloud",estimator.type = "modulus", max.dist = dist.max.data/2)

plot(vario.cloud.robust, main = "CLOUD", cex.main = 1, cex.lab = 1)

vario.bc.robust <- variog(geodata = geodataset.residuals, option = "bin",bin.cloud = TRUE, pairs.min = 30, max.dist = dist.max.data/2,estimator.type = "modulus", uvec = seq(1, dist.max.data/2,l = 13))

plot(vario.bc.robust, bin.cloud = TRUE, cex.lab = 1, main = "\nBINNED BOXPLOTS",cex.main = 1)

vario.b.robust <- variog(geodata = geodataset.residuals, option = "bin",pairs.min = 30, max.dist = dist.max.data/2, estimator.type = "modulus",uvec = seq(1, dist.max.data/2, l = 13))

plot(vario.b.robust, main = "EMPIRICAL VARIOGRAMS (Robust)\nBINNED",cex.main = 1, cex.lab = 1, cex = 1, pch = 16)
```

Identifying Anisotropy
```{r}
variod <- variog4(geodata = geodataset.residuals, option = "bin",pairs.min = 30, max.dist = dist.max.data/2, estimator.type = "classical",uvec = seq(1, dist.max.data/2, l = 13))

plot(variod, lyt = 2, legend = FALSE)
#plot the directional variogram
legend(x = "bottomright", inset = 0.01, lty = c(1, 2, 3, 4),col = c("black", "red", "green", "blue"), legend = c("0º","45º", "90º", "135º"), cex = 0.5)
```

### Monte Carlo test for checking spatial correlation
```{r}

for( i in 1:100){
  set.seed(i)#fix the seed
  indep.env <- variog.mc.env(geodataset.residuals, obj.variog = vario.b.robust,nsim = 500)
  if(prod(vario.b.robust$v[-1]>indep.env$v.lower[-1]) ==1 && prod(vario.b.robust$v<indep.env$v.upper-1) ==1 )
    break
}

plot(vario.b.robust, envelope = indep.env, main = "CONFIDENCE BANDS FOR INDEPENDENT MODEL",lwd = 2, pch = 16)

```

All the values of the variogram are inside the envelope therefore it can be concluded that the process does not present spatial correlation.





